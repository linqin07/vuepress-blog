(window.webpackJsonp=window.webpackJsonp||[]).push([[140],{537:function(s,a,t){"use strict";t.r(a);var e=t(20),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"简单网络管理协议-snmp"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简单网络管理协议-snmp"}},[s._v("#")]),s._v(" 简单网络管理协议（SNMP）")]),s._v(" "),a("p",[s._v("目前snmp定义了三个版本的网络管理协议：SNMP v1，SNMP v2，SNMP v3。SNMP v1，v2有很多共同的特征，SNMP v3 在先前的版本地基础上增加了安全和远程配置能力 。")]),s._v(" "),a("h3",{attrs:{id:"_1-snmp的安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-snmp的安装"}},[s._v("#")]),s._v(" 1.snmp的安装")]),s._v(" "),a("p",[s._v("安装必备套件net-snmp net-snmp-devel net-snmp-utils")]),s._v(" "),a("blockquote",[a("p",[s._v("net-snmp：提供了一个入口，使得监控服务器可以通过snmp协议从这个入口与被监控机器通信")]),s._v(" "),a("p",[s._v("net-snmp-devel： 是为了使用net-snmp-config, net-snmp-utils是为了使用snmpwalk")]),s._v(" "),a("p",[s._v("net-snmp-libs：　 提供了运行需要的库文件")]),s._v(" "),a("p",[s._v("net-snmp-utils：  提供了一套工具，可以利用snmp协议进行通信，snmpget、snmpwalk命令都在该包中")])]),s._v(" "),a("p",[s._v("在centos/redhat平台下通过如下命令安装：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  yum -y install net-snmp net-snmp-devel net-snmp-utils")]),s._v("\n")])])]),a("p",[s._v("查看版本")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@dev032 snmp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# snmpd -v")]),s._v("\nNET-SNMP version:  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.7")]),s._v(".2\nWeb:               http://www.net-snmp.org/\nEmail:             net-snmp-coders@lists.sourceforge.net\n")])])]),a("h3",{attrs:{id:"_2-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-配置"}},[s._v("#")]),s._v(" 2.配置")]),s._v(" "),a("p",[s._v("配置文件目录：/etc/snmp 下有两个配置文件 snmpd.conf 和 snmptrap.conf")]),s._v(" "),a("p",[s._v("修改配置")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#       sec.name  source          community")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#com2sec notConfigUser  default       public")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("########################## 新定义一个用户myuser，并设置用户的密码为fistforward #################################################")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#项目分类名｜用户名    ｜   可访问的来源地址｜社区（就是密码）")]),s._v("\ncom2sec myuser          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.117")]),s._v(".186.40      passed\ncom2sec myuser          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1          public\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##################################################  定义组配置 ################################################################")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#       groupName      securityModel securityName")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#group   notConfigGroup v2c           notConfigUser")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#定义一个组，将我们的用户加入进这个组,同时指定改组可以使用的snmp的协议版本")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#项目分类名｜组名｜协议版本｜    添加的用户")]),s._v("\ngroup   mygroup v1           myuser\ngroup   mygroup v2c          myuser\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##########################################  定义一个view视图，设置视图的可看范围  ################################################")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#       name           incl/excl     subtree         mask(optional)")]),s._v("\nview    systemview    included   .1.3.6.1.2.1.1\nview    systemview    included   .1.3.6.1.2.1.25.1.1\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#项目名分类｜视图名称｜包含/排除｜范围")]),s._v("\nview      all       included   .1\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("######################################################  定义组可以看到的视图权限 #################################################")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#项目分类名|组名｜描述｜sec.model|sec.level|prefix|可读读视图|可写的视图|notif")]),s._v("\naccess    mygroup        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("    any     noauth    exact  all    all     all\n")])])]),a("p",[s._v("添加项")]),s._v(" "),a("ul",[a("li",[s._v("view      all       included   .1")]),s._v(" "),a("li",[s._v('access    mygroup        ""    any     noauth    exact  all    all     all  权限都设置为视图 all')])]),s._v(" "),a("p",[s._v("重启服务，通过 snmp 查看系统名字命令")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("snmpwalk "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" 2c "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" public localhost sysName.0\n或者\nsnmpwalk "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" public localhost sysName.0\n")])])]),a("h3",{attrs:{id:"添加自定义oid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加自定义oid"}},[s._v("#")]),s._v(" 添加自定义OID")]),s._v(" "),a("p",[s._v("首先我们需要找一个oid是否被系统暂用，比如.1.3.6.1.4.1.2021.5000")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("$ snmpwalk "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" 2c "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" public www.ttlsa.com .1.3.6.1.4.1.2021.5000\nUCD-SNMP-MIB::ucdavis.5000 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" No Such Object available on this agent at this OID\n")])])]),a("p",[s._v("增加自定 SNMP OID 编写脚本")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /root/scripts/check_nginx.sh")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("nginxNum")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("/bin/ps aux "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" /bin/grep nginx "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$nginxNum")]),s._v("\n")])])]),a("p",[s._v("修改配置")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/snmp/snmpd.conf\nextend .1.3.6.1.4.1.2021.5000 check_nginx /root/scripts/check_nginx.sh // 增加这一行\n")])])]),a("p",[s._v("重启服务再次检查是否被使用，可以有结果返回。")]),s._v(" "),a("h3",{attrs:{id:"查看oid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看oid"}},[s._v("#")]),s._v(" 查看OID")]),s._v(" "),a("p",[s._v("snmptranslate -To | head -n 10")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v(".1.3\n.1.3.6\n.1.3.6.1\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])])]),a("h3",{attrs:{id:"添加自定义mib"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加自定义mib"}},[s._v("#")]),s._v(" 添加自定义MIB")]),s._v(" "),a("p",[s._v("过于复杂，自行谷歌。")]),s._v(" "),a("h3",{attrs:{id:"配置snmp-v3认证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置snmp-v3认证"}},[s._v("#")]),s._v(" 配置snmp v3认证")]),s._v(" "),a("p",[s._v("配置前，先使用 service snmpd stop 命令停止 snmpd 服务。")]),s._v(" "),a("blockquote",[a("h6",{attrs:{id:"参数说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参数说明"}},[s._v("#")]),s._v(" 参数说明")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("-ro")]),s._v(":用户读写权限，表示用户fx为只具有读权限")]),s._v(" "),a("li",[a("code",[s._v("fx")]),s._v("：用户名")]),s._v(" "),a("li",[a("code",[s._v("-a MD5")]),s._v(":认证方式，MD5|SHA散列方式")]),s._v(" "),a("li",[a("code",[s._v("-A auth123456")]),s._v("：设置认证密码，密码必须大于8个字符")]),s._v(" "),a("li",[a("code",[s._v("-x DES")]),s._v(":加密方式，这边支持DES、AES128、AES192、AES256两种")]),s._v(" "),a("li",[a("code",[s._v("priv123456")]),s._v("：加密口令，必须大于8位")])])]),s._v(" "),a("ul",[a("li",[a("p",[s._v("noAuthNoPriv（不认证也不加密）")]),s._v(" "),a("p",[s._v("authNoPriv（认证但是不加密）")])]),s._v(" "),a("li",[a("p",[s._v("增加用户 fxa "),a("code",[s._v("net-snmp-create-v3-user -ro -A auth123456 -a MD5 fxa")])]),s._v(" "),a("p",[s._v("验证: "),a("code",[s._v("snmpwalk -v 3 -u fxa -a MD5 -A auth123456 -l authNoPriv 127.0.0.1 sysName.0")])])]),s._v(" "),a("li",[a("p",[s._v("authPriv（既认证又加密）")]),s._v(" "),a("p",[s._v("增加用户 fx "),a("code",[s._v("net-snmp-create-v3-user -ro -A auth123456 -X priv123456 -a MD5 -x DES fx")])]),s._v(" "),a("p",[s._v("检查 if 前缀 "),a("code",[s._v("snmpwalk -v3 -u fx -l authPriv -a MD5 -A auth123456 -X priv123456 127.0.0.1 if")])])])]),s._v(" "),a("h2",{attrs:{id:"snmptrapd"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#snmptrapd"}},[s._v("#")]),s._v(" snmptrapd")]),s._v(" "),a("p",[s._v("使用net-snmp提供的 snmptrap 等工具可以实现trap的发送和接收。以 authCommunity 开头的一行配置了 snmptrapd 的安全设置，表示可以接收 community 为 public 的 SNMP Trap，并且本进程可以有 log，net 和 execute 的权限。下面是具体做法。")]),s._v(" "),a("blockquote",[a("p",[s._v("sudo snmptrapd -d -f -Lo")]),s._v(" "),a("p",[s._v("上面命令中的选项表示：")]),s._v(" "),a("p",[s._v("-C ： 表示不使用net-snmp默认路径下的配置文件 snmptrapd.conf；")]),s._v(" "),a("p",[s._v("-c ： 指定snmptrapd.conf文件；")]),s._v(" "),a("p",[s._v("-d ： 显示收到和发送的数据报，通过这个选项可以看到数据报文；")]),s._v(" "),a("p",[s._v("-f ： 默认情况下，snmptrapd是在后台中运行的，加上这个选项，表示在前台运行；")]),s._v(" "),a("p",[s._v("-L ： 指定日志记录在哪里，后面的o表示直接输出到屏幕上，如果是跟着f表示日志记录到指定的文件中；")])]),s._v(" "),a("p",[s._v("可通过snmptrapd -h查看命令帮助了解该命令的使用。")]),s._v(" "),a("ul",[a("li",[s._v("启动 snmptrapd 监听窗口（可以指定config文件的位置）")])]),s._v(" "),a("p",[s._v("在前台运行，将log信息打印到stdout：\n"),a("code",[s._v("$ snmptrapd -C -c ./snmptrapd.conf -f -Lo")])]),s._v(" "),a("p",[s._v("也可以在后台运行，并将log信息打印到文件中：\n"),a("code",[s._v("$ snmptrapd -C -c ./snmptrapd.conf -Lf /tmp/trapd.log")])]),s._v(" "),a("ul",[a("li",[a("p",[s._v("通过snmptrap工具发送一个trap（目标地址是“127.0.0.1:162”）")]),s._v(" "),a("p",[s._v("snmptrap的命令行格式如下：")])])]),s._v(" "),a("p",[s._v("snmptrap -v [2c|3] [COMMON OPTIONS]        uptime      trap-oid                [OID TYPE VALUE]")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("snmptrap "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" 2c "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" public "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:162 "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v(" .1.3.6.1.4.1.2021.251.1  sysLocation.0 s "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test"')]),s._v("\nsnmptrap "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" 2c "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" public "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:162 "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"12345678"')]),s._v(" .1.3.6.1.4.1.2021.251.1  sysLocation.0 s "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"test"')]),s._v("\n")])])]),a("ul",[a("li",[s._v("查看 snmptrapd 的log信息，可以看到我们发送的")])]),s._v(" "),a("p",[s._v("trap：\n2014-01-14 17:08:13 localhost [UDP: [127.0.0.1]:59609->[127.0.0.1]]:\nDISMAN-EVENT-MIB::sysUpTimeInstance = Timeticks: (3081118) 8:33:31.18 SNMPv2-MIB::snmpTrapOID.0 = OID: UCD-SNMP-MIB::ucdStart SNMPv2-MIB::sysLocation.0 = STRING: test")]),s._v(" "),a("h2",{attrs:{id:"snmp-v3-trap"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#snmp-v3-trap"}},[s._v("#")]),s._v(" SNMP v3 "),a("a",{attrs:{href:"https://support.nagios.com/kb/article.php?id=493",target:"_blank",rel:"noopener noreferrer"}},[s._v("Trap"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("The command below takes the form of:")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("snmptrap -v <snmp_version> -e <engine_id> -u <security_username> -a <authentication_protocal> -A <authentication_protocal_pass_phrase> -x <privacy_protocol> -X <privacy_protocol_pass_phrase> <destination_host> <uptime> <OID_or_MIB> <object> <value_type> <value>\n")])])]),a("p",[s._v("Using a MIB:")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("snmptrap -v 3 -e 0x090807060504030201 -u the_user_name -a SHA -A the_SHA_string -x AES -X the_AES_string localhost '' NET-SNMP-EXAMPLES-MIB::netSnmpExampleHeartbeatNotification netSnmpExampleHeartbeatRate i 123456\n")])])]),a("p",[s._v("Shortening the MIB:")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("snmptrap -v 3 -e 0x090807060504030201 -u the_user_name -a SHA -A the_SHA_string -x AES -X the_AES_string localhost '' netSnmpExampleHeartbeatNotification netSnmpExampleHeartbeatRate i 123456\n")])])]),a("p",[s._v("Using OID's instead of MIB:")]),s._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("snmptrap -v 3 -e 0x090807060504030201 -u the_user_name -a SHA -A the_SHA_string -x AES -X the_AES_string localhost '' 1.3.6.1.4.1.8072.2.3.0.1 1.3.6.1.4.1.8072.2.3.2.1 i 123456\n")])])]),a("p",[s._v("The commands above required the following settings in /etc/snmp/snmptrapd.conf")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("disableAuthorization "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\ntraphandle default /usr/sbin/snmptthandler\ncreateUser "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" 0x090807060504030201 the_user_name SHA the_SHA_string AES the_AES_string\nauthUser log,execute,net the_user_name\n")])])])])}),[],!1,null,null,null);a.default=n.exports}}]);